<view class="container">
  <!-- è“ç‰™è¿æ¥ç®¡ç†åŒº -->
  <view class="section connection-section">
    <view class="section-header">
      <text class="section-title">ğŸ“¡ è“ç‰™è®¾å¤‡è¿æ¥</text>
    </view>
    
    <view class="connection-card">
      <view class="connection-row" wx:if="{{deviceName}}">
        <text class="label">å·²è¿æ¥è®¾å¤‡:</text>
        <text class="device-name">{{deviceName}}</text>
      </view>
      
      <view class="button-group">
        <button
          class="connect-btn {{connectionStatus}}"
          bindtap="onConnect"
          disabled="{{isConnecting || isScanning}}"
          loading="{{isConnecting || isScanning}}"
        >
          {{buttonText}}
        </button>
      </view>
      
      <!-- è®¾å¤‡åˆ—è¡¨ -->
      <view class="device-list" wx:if="{{showDeviceList && devices.length > 0}}">
        <view class="device-list-header">
          <text>æ‰¾åˆ°ä»¥ä¸‹ESP32-Motorè®¾å¤‡ï¼Œç‚¹å‡»è¿æ¥:</text>
        </view>
        <view
          class="device-item {{deviceId === item.deviceId ? 'active' : ''}}"
          wx:for="{{devices}}"
          wx:key="deviceId"
          bindtap="onSelectDevice"
          data-device-id="{{item.deviceId}}"
          data-device-name="{{item.name || item.localName}}"
        >
          <view class="device-info">
            <text class="device-name">{{item.name || item.localName}}</text>
            <text class="device-id">è®¾å¤‡ID: {{item.deviceId}}</text>
            <text class="device-rssi">ä¿¡å·å¼ºåº¦: {{item.RSSI}}dBm</text>
          </view>
          <view class="device-connect-icon">
            {{deviceId === item.deviceId ? 'âœ“' : 'â†’'}}
          </view>
        </view>
      </view>
      
      <!-- è¿æ¥æˆåŠŸæç¤º -->
      <view class="success-message" wx:if="{{connectionStatus === 'connected'}}">
        <text>âœ… è®¾å¤‡è¿æ¥æˆåŠŸï¼è“ç‰™é€šä¿¡å·²å»ºç«‹ã€‚</text>
      </view>
      
      <!-- é”™è¯¯æç¤º -->
      <view class="error-message" wx:if="{{errorMessage}}">
        <text>{{errorMessage}}</text>
      </view>
      
      <!-- è‡ªåŠ¨é‡è¯•çŠ¶æ€ -->
      <view class="retry-status" wx:if="{{autoRetryTimer && retryCount > 0}}">
        <text>è‡ªåŠ¨é‡è¯•ä¸­... {{retryCount}}/{{maxRetryCount}}</text>
      </view>
    </view>
  </view>

  <!-- ç”µæœºæ§åˆ¶åŒº -->
  <view class="section control-section" wx:if="{{connectionStatus === 'connected'}}">
    <view class="section-header">
      <text class="section-title">âš™ï¸ ç”µæœºæ§åˆ¶</text>
    </view>
    
    <view class="control-card">
      <!-- è¿è¡Œæ—¶é•¿æ§åˆ¶ -->
      <view class="control-item">
        <view class="control-label">
          <text>è¿è¡Œæ—¶é•¿</text>
          <text class="control-value">{{runDuration}}ç§’</text>
        </view>
        <view class="control-content">
          <view class="input-group">
            <button
              class="control-btn-small decrease-btn"
              bindtap="onRunDurationDecrease"
              disabled="{{runDuration <= 1}}"
            >
              -
            </button>
            <input
              class="control-input-new"
              type="number"
              value="{{runDuration}}"
              min="1"
              max="999"
              bindinput="onRunDurationInput"
              bindblur="onRunDurationBlur"
            />
            <button
              class="control-btn-small increase-btn"
              bindtap="onRunDurationIncrease"
              disabled="{{runDuration >= 999}}"
            >
              +
            </button>
          </view>
        </view>
      </view>
      
      <!-- åœæ­¢é—´éš”æ§åˆ¶ -->
      <view class="control-item">
        <view class="control-label">
          <text>åœæ­¢é—´éš”</text>
          <text class="control-value">{{stopDuration}}ç§’</text>
        </view>
        <view class="control-content">
          <view class="input-group">
            <button
              class="control-btn-small decrease-btn"
              bindtap="onStopDurationDecrease"
              disabled="{{stopDuration <= 0}}"
            >
              -
            </button>
            <input
              class="control-input-new"
              type="number"
              value="{{stopDuration}}"
              min="0"
              max="999"
              bindinput="onStopDurationInput"
              bindblur="onStopDurationBlur"
            />
            <button
              class="control-btn-small increase-btn"
              bindtap="onStopDurationIncrease"
              disabled="{{stopDuration >= 999}}"
            >
              +
            </button>
          </view>
        </view>
      </view>
      
      <!-- ç³»ç»Ÿå¼€å…³æ§åˆ¶å·²åˆ é™¤ -->
    </view>
  </view>

  <!-- ç³»ç»ŸçŠ¶æ€å±•ç¤ºåŒº -->
  <view class="section status-section" wx:if="{{connectionStatus === 'connected'}}">
    <view class="section-header">
      <text class="section-title">ğŸ“Š ç³»ç»ŸçŠ¶æ€</text>
    </view>
    
    <view class="status-card">
      <view class="status-row">
        <text class="status-label">ç”µæœºçŠ¶æ€:</text>
        <text class="status-value motor-state state-{{systemStatus.state}}">
          <text wx:if="{{systemStatus.state === 0}}">å·²åœæ­¢ğŸ”´</text>
          <text wx:elif="{{systemStatus.state === 1}}">è¿è¡Œä¸­ğŸŸ¢</text>
          <text wx:elif="{{systemStatus.state === 2}}">å·²æš‚åœğŸŸ¡</text>
          <text wx:elif="{{systemStatus.state === 3}}">å¯åŠ¨ä¸­ğŸ”µ</text>
          <text wx:else>{{systemStatus.stateName}}{{systemStatus.state}}</text>
        </text>
      </view>
      
      <view class="status-row">
        <text class="status-label">è¿è¡Œæ—¶é•¿:</text>
        <text class="status-value">{{systemStatus.runDuration}}ç§’</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">åœæ­¢é—´éš”:</text>
        <text class="status-value">{{systemStatus.stopDuration}}ç§’</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">è¿è¡Œå€’è®¡æ—¶:</text>
        <text class="status-value countdown">{{systemStatus.remainingRunTime}}ç§’</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">åœæ­¢å€’è®¡æ—¶:</text>
        <text class="status-value countdown">{{systemStatus.remainingStopTime}}ç§’</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">å½“å‰å¾ªç¯:</text>
        <text class="status-value">{{systemStatus.currentCycleCount}}æ¬¡</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">æ€»å¾ªç¯è®¾ç½®:</text>
        <text class="status-value">{{systemStatus.cycleCount === 0 ? 'æ— é™å¾ªç¯' : systemStatus.cycleCount + 'æ¬¡'}}</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">è‡ªåŠ¨å¯åŠ¨:</text>
        <text class="status-value">{{systemStatus.autoStart ? 'å¼€å¯ âœ…' : 'å…³é—­ âŒ'}}</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">è¿è¡Œæ—¶é—´:</text>
        <text class="status-value">{{systemStatus.formattedUptime}}</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">ç©ºé—²å†…å­˜:</text>
        <text class="status-value">{{systemStatus.formattedFreeHeap}}</text>
      </view>
    </view>
  </view>
</view>
