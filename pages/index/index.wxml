<view class="container">
  <!-- 蓝牙连接管理区 -->
  <view class="section connection-section">
    <view class="section-header">
      <text class="section-title">📡 蓝牙设备连接</text>
    </view>
    
    <view class="connection-card">
      <view class="connection-row" wx:if="{{deviceName}}">
        <text class="label">已连接设备:</text>
        <text class="device-name">{{deviceName}}</text>
      </view>
      
      <view class="button-group">
        <button
          class="connect-btn {{connectionStatus}}"
          bindtap="onConnect"
          disabled="{{isConnecting || isScanning}}"
          loading="{{isConnecting || isScanning}}"
        >
          {{buttonText}}
        </button>
      </view>
      
      <!-- 设备列表 -->
      <view class="device-list" wx:if="{{showDeviceList && devices.length > 0}}">
        <view class="device-list-header">
          <text>找到以下ESP32-Motor设备，点击连接:</text>
        </view>
        <view
          class="device-item {{deviceId === item.deviceId ? 'active' : ''}}"
          wx:for="{{devices}}"
          wx:key="deviceId"
          bindtap="onSelectDevice"
          data-device-id="{{item.deviceId}}"
          data-device-name="{{item.name || item.localName}}"
        >
          <view class="device-info">
            <text class="device-name">{{item.name || item.localName}}</text>
            <text class="device-id">设备ID: {{item.deviceId}}</text>
            <text class="device-rssi">信号强度: {{item.RSSI}}dBm</text>
          </view>
          <view class="device-connect-icon">
            {{deviceId === item.deviceId ? '✓' : '→'}}
          </view>
        </view>
      </view>
      
      <!-- 连接成功提示 -->
      <view class="success-message" wx:if="{{connectionStatus === 'connected'}}">
        <text>✅ 设备连接成功！蓝牙通信已建立。</text>
      </view>
      
      <!-- 错误提示 -->
      <view class="error-message" wx:if="{{errorMessage}}">
        <text>{{errorMessage}}</text>
      </view>
      
      <!-- 自动重试状态 -->
      <view class="retry-status" wx:if="{{autoRetryTimer && retryCount > 0}}">
        <text>自动重试中... {{retryCount}}/{{maxRetryCount}}</text>
      </view>
    </view>
  </view>

  <!-- 电机控制区 -->
  <view class="section control-section" wx:if="{{connectionStatus === 'connected'}}">
    <view class="section-header">
      <text class="section-title">⚙️ 电机控制</text>
    </view>
    
    <view class="control-card">
      <!-- 运行时长控制 -->
      <view class="control-line">
        <text class="control-label-line">运行时长：</text>
        <button
          class="control-btn-inline decrease-btn"
          bindtap="onRunDurationDecrease"
          disabled="{{runDuration <= 1}}"
        >
          -
        </button>
        <input
          class="control-input-inline"
          type="number"
          value="{{runDuration}}"
          min="1"
          max="999"
          bindinput="onRunDurationInput"
          bindblur="onRunDurationBlur"
        />
        <button
          class="control-btn-inline increase-btn"
          bindtap="onRunDurationIncrease"
          disabled="{{runDuration >= 999}}"
        >
          +
        </button>
        <text class="control-unit">秒</text>
      </view>
      
      <!-- 停止间隔控制 -->
      <view class="control-line">
        <text class="control-label-line">停止间隔：</text>
        <button
          class="control-btn-inline decrease-btn"
          bindtap="onStopDurationDecrease"
          disabled="{{stopDuration <= 0}}"
        >
          -
        </button>
        <input
          class="control-input-inline"
          type="number"
          value="{{stopDuration}}"
          min="0"
          max="999"
          bindinput="onStopDurationInput"
          bindblur="onStopDurationBlur"
        />
        <button
          class="control-btn-inline increase-btn"
          bindtap="onStopDurationIncrease"
          disabled="{{stopDuration >= 999}}"
        >
          +
        </button>
        <text class="control-unit">秒</text>
      </view>
      
      <!-- 应用设置按钮 -->
      <view class="control-buttons">
        <button
          class="control-btn apply-btn"
          bindtap="onApplySettings"
          disabled="{{isApplying}}"
          loading="{{isApplying}}"
        >
          {{isApplying ? '应用中...' : '应用设置'}}
        </button>
      </view>
    </view>
  </view>

  <!-- 调速器控制区 -->
  <view class="section speed-control-section" wx:if="{{connectionStatus === 'connected'}}">
    <view class="section-header">
      <text class="section-title">🎛️ 调速器控制</text>
    </view>
    
    <view class="control-card">
      <!-- 频率控制 -->
      <view class="control-line">
        <text class="control-label-line">频率：</text>
        <button
          class="control-btn-inline decrease-btn"
          bindtap="onFrequencyDecrease"
        >
          -
        </button>
        <input
          class="control-input-inline"
          type="number"
          value="{{frequency}}"
          bindinput="onFrequencyInput"
          bindblur="onFrequencyBlur"
        />
        <button
          class="control-btn-inline increase-btn"
          bindtap="onFrequencyIncrease"
        >
          +
        </button>
        <text class="control-unit">KHz</text>
      </view>
      
      <!-- 占空比控制 -->
      <view class="control-line">
        <text class="control-label-line">占空比：</text>
        <button
          class="control-btn-inline decrease-btn"
          bindtap="onDutyCycleDecrease"
        >
          -
        </button>
        <input
          class="control-input-inline"
          type="number"
          value="{{dutyCycle}}"
          bindinput="onDutyCycleInput"
          bindblur="onDutyCycleBlur"
        />
        <button
          class="control-btn-inline increase-btn"
          bindtap="onDutyCycleIncrease"
        >
          +
        </button>
        <text class="control-unit">%</text>
      </view>
      
      <!-- 最小输出控制 -->
      <view class="control-line">
        <text class="control-label-line">最小输出：</text>
        <button
          class="control-btn-inline decrease-btn"
          bindtap="onMinOutputDecrease"
        >
          -
        </button>
        <input
          class="control-input-inline"
          type="number"
          value="{{minOutput}}"
          bindinput="onMinOutputInput"
          bindblur="onMinOutputBlur"
        />
        <button
          class="control-btn-inline increase-btn"
          bindtap="onMinOutputIncrease"
        >
          +
        </button>
        <text class="control-unit">%</text>
      </view>
      
      <!-- 最大输出控制 -->
      <view class="control-line">
        <text class="control-label-line">最大输出：</text>
        <button
          class="control-btn-inline decrease-btn"
          bindtap="onMaxOutputDecrease"
        >
          -
        </button>
        <input
          class="control-input-inline"
          type="number"
          value="{{maxOutput}}"
          bindinput="onMaxOutputInput"
          bindblur="onMaxOutputBlur"
        />
        <button
          class="control-btn-inline increase-btn"
          bindtap="onMaxOutputIncrease"
        >
          +
        </button>
        <text class="control-unit">%</text>
      </view>
      
      <!-- 缓启动时间控制 -->
      <view class="control-line">
        <text class="control-label-line">缓启动时间：</text>
        <button
          class="control-btn-inline decrease-btn"
          bindtap="onSoftStartTimeDecrease"
        >
          -
        </button>
        <input
          class="control-input-inline"
          type="number"
          value="{{softStartTime}}"
          bindinput="onSoftStartTimeInput"
          bindblur="onSoftStartTimeBlur"
        />
        <button
          class="control-btn-inline increase-btn"
          bindtap="onSoftStartTimeIncrease"
        >
          +
        </button>
        <text class="control-unit">秒</text>
      </view>
      
      <!-- 缓停止时间控制 -->
      <view class="control-line">
        <text class="control-label-line">缓停止时间：</text>
        <button
          class="control-btn-inline decrease-btn"
          bindtap="onSoftStopTimeDecrease"
        >
          -
        </button>
        <input
          class="control-input-inline"
          type="number"
          value="{{softStopTime}}"
          bindinput="onSoftStopTimeInput"
          bindblur="onSoftStopTimeBlur"
        />
        <button
          class="control-btn-inline increase-btn"
          bindtap="onSoftStopTimeIncrease"
        >
          +
        </button>
        <text class="control-unit">秒</text>
      </view>
      
      <!-- 分割线 -->
      <view style="border-bottom: 1px solid #eee; margin: 10px 0;"></view>
      
      <!-- 开关控制 -->
      <view class="control-line switch-line">
        <!-- 外接开关 -->
        <view class="switch-item" style="display: flex;flex-direction: column;justify-content: center;flex: 1;">
          <text class="switch-label" style="padding-bottom:10px;">外接开关：</text>
          <switch
            class="control-switch"
            checked="{{externalSwitch}}"
            bindchange="onExternalSwitchChange"
          />
        </view>
        
        <!-- 0-10V 控制开关 -->
        <view class="switch-item" style="display: flex;flex-direction: column;justify-content: center;flex: 1;text-align: center;">
          <text class="switch-label" style="padding-bottom:10px;">0-10V控制：</text>
          <switch
            class="control-switch"
            checked="{{analogControl}}"
            bindchange="onAnalogControlChange"
          />
        </view>
        
        <!-- 开机默认开关 -->
        <view class="switch-item" style="display: flex;flex-direction: column;justify-content: center;flex: 1;text-align: right;">
          <text class="switch-label" style="padding-bottom:10px;">开机默认：</text>
          <switch
            class="control-switch"
            checked="{{powerOnState}}"
            bindchange="onPowerOnStateChange"
          />
        </view>
      </view>
      
      <!-- 应用设置按钮 -->
      <view class="control-buttons">
        <button
          class="control-btn apply-btn"
          bindtap="onApplySpeedSettings"
        >
          应用设置
        </button>
      </view>
    </view>
  </view>

  <!-- 系统状态展示区 -->
  <view class="section status-section" wx:if="{{connectionStatus === 'connected'}}">
    <view class="section-header">
      <text class="section-title">📊 系统状态</text>
    </view>
    
    <view class="status-card">
      <view class="status-row">
        <text class="status-label">电机状态:</text>
        <text class="status-value motor-state state-{{systemStatus.state}}">
          <text wx:if="{{systemStatus.state === 0}}">已停止🔴</text>
          <text wx:elif="{{systemStatus.state === 1}}">运行中🟢</text>
          <text wx:elif="{{systemStatus.state === 2}}">已暂停🟡</text>
          <text wx:elif="{{systemStatus.state === 3}}">启动中🔵</text>
          <text wx:else>{{systemStatus.stateName}}{{systemStatus.state}}</text>
        </text>
      </view>
      
      <view class="status-row">
        <text class="status-label">运行时长:</text>
        <text class="status-value">{{systemStatus.runDuration}}秒</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">停止间隔:</text>
        <text class="status-value">{{systemStatus.stopDuration}}秒</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">运行倒计时:</text>
        <text class="status-value countdown">{{systemStatus.remainingRunTime}}秒</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">停止倒计时:</text>
        <text class="status-value countdown">{{systemStatus.remainingStopTime}}秒</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">芯片温度:</text>
        <text class="status-value">{{systemStatus.chipTemperature}}°C</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">当前循环:</text>
        <text class="status-value">{{systemStatus.currentCycleCount}}次</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">总循环设置:</text>
        <text class="status-value">{{systemStatus.cycleCount === 0 ? '无限循环' : systemStatus.cycleCount + '次'}}</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">自动启动:</text>
        <text class="status-value">{{systemStatus.autoStart ? '开启 ✅' : '关闭 ❌'}}</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">运行时间:</text>
        <text class="status-value">{{systemStatus.formattedUptime}}</text>
      </view>
      
      <view class="status-row">
        <text class="status-label">空闲内存:</text>
        <text class="status-value">{{systemStatus.formattedFreeHeap}}</text>
      </view>
    </view>
  </view>

</view>
